<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Админ-панель</title>
  <!-- Подключаем Tailwind CSS для удобного стилизования -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Подключаем Chart.js для построения графиков -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Подключаем Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons@latest/iconfont/tabler-icons.min.css" />
  <style>
    /* Основные стили */
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0f172a, #1e293b); 
      min-height: 100vh; 
      margin: 0; 
      padding-bottom: 100px; /* нижний отступ для видимости элементов */
      color: #e5e7eb;
      overflow-x: hidden; /* запрет горизонтального скролла */
    }
    /* Скрываем скроллбар для эстетики */
    ::-webkit-scrollbar { display: none; }
    * { scrollbar-width: none; }
    /* Контейнер для админ-контента */
    #admin-container {
      max-width: 1024px;
      margin: 0 auto;
    }
    .card {
      background: #1f2937;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .admin-tab {
      transition: background 0.3s;
    }
    .admin-tab:hover {
      background: #2563eb;
    }
    .admin-tab-content {
      padding: 16px;
    }
    /* Стили для формы логина */
    #login-container {
      max-width: 400px;
      margin: 100px auto;
      background: #1f2937;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="p-4">
  <div id="admin-container">
    <h1 class="text-3xl font-bold mb-6 text-center">Админ-панель</h1>
    
    <!-- Форма логина (показывается, если adminLoggedIn не установлен) -->
    <div id="login-container" class="hidden">
      <h2 class="text-2xl font-semibold mb-4 text-center">Вход</h2>
      <input id="login-username" type="text" placeholder="Логин" class="w-full p-2 bg-gray-700 rounded mb-4" />
      <input id="login-password" type="password" placeholder="Пароль" class="w-full p-2 bg-gray-700 rounded mb-4" />
      <button onclick="adminLogin()" class="w-full bg-blue-500 p-2 rounded text-white">Войти</button>
      <div id="login-error" class="mt-2 text-center text-red-500 hidden">Неверный логин или пароль</div>
    </div>
    
    <!-- Админ-контент (отображается после успешного входа) -->
    <div id="admin-content" class="hidden">
      <!-- Навигация по вкладкам -->
      <div class="mb-4 flex justify-center space-x-4">
        <button class="admin-tab px-4 py-2 bg-blue-500 rounded-lg text-white" onclick="showTab('tasks')">Задания</button>
        <button class="admin-tab px-4 py-2 bg-blue-500 rounded-lg text-white" onclick="showTab('users')">Пользователи</button>
        <button class="admin-tab px-4 py-2 bg-blue-500 rounded-lg text-white" onclick="showTab('stats')">Статистика</button>
        <button class="admin-tab px-4 py-2 bg-blue-500 rounded-lg text-white" onclick="showTab('logs')">Журнал</button>
        <button class="admin-tab px-4 py-2 bg-blue-500 rounded-lg text-white" onclick="showTab('broadcast')">Рассылка</button>
        <button onclick="adminLogout()" class="admin-tab px-4 py-2 bg-red-500 rounded-lg text-white">Выйти</button>
      </div>
      
      <!-- Контейнер для вкладок -->
      <div id="tab-content">
        <!-- Вкладка "Задания" -->
        <div id="tasks-tab" class="admin-tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Список заданий</h2>
          <!-- Фильтр заданий -->
          <input id="task-search" type="text" placeholder="Поиск заданий" class="w-full p-2 bg-gray-700 rounded mb-4" oninput="loadTasks()">
          <button onclick="deleteAllTasks()" class="mb-4 bg-red-500 px-4 py-2 rounded">Удалить все задания</button>
          <div id="tasks-list"></div>
        </div>
        
        <!-- Вкладка "Пользователи" -->
        <div id="users-tab" class="admin-tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Список пользователей</h2>
          <button onclick="unbanAllUsers()" class="mb-4 bg-green-500 px-4 py-2 rounded">Разбанить всех пользователей</button>
          <div id="users-list"></div>
        </div>
        
        <!-- Вкладка "Статистика" -->
        <div id="stats-tab" class="admin-tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Статистика</h2>
          <div id="stats-summary" class="mb-4"></div>
          <canvas id="stats-chart" class="bg-white rounded"></canvas>
        </div>
        
        <!-- Вкладка "Журнал" -->
        <div id="logs-tab" class="admin-tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Журнал действий</h2>
          <div id="logs-list" class="overflow-y-auto max-h-64"></div>
          <button onclick="clearLogs()" class="mt-4 bg-red-500 px-4 py-2 rounded">Очистить журнал</button>
        </div>
        
        <!-- Вкладка "Рассылка" -->
        <div id="broadcast-tab" class="admin-tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Рассылка уведомлений</h2>
          <textarea id="broadcast-message" rows="4" class="w-full p-2 bg-gray-700 rounded mb-4" placeholder="Введите сообщение для рассылки"></textarea>
          <button onclick="sendBroadcast()" class="w-full bg-blue-500 p-2 rounded text-white">Отправить уведомление</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Константы для логина
    const ADMIN_USERNAME = "admin";
    const ADMIN_PASSWORD = "qwerty";
    
    // Функция входа: проверка логина и пароля
    function adminLogin() {
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;
      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        localStorage.setItem("adminLoggedIn", "true");
        showAdminContent();
        showTab("tasks");
        loadTasks();
        loadUsers();
        loadStats();
        loadLogs();
      } else {
        document.getElementById("login-error").classList.remove("hidden");
      }
    }
    
    // Функция выхода
    function adminLogout() {
      localStorage.removeItem("adminLoggedIn");
      location.reload();
    }
    
    // Проверка, выполнен ли вход
    function checkAdminLogin() {
      if (localStorage.getItem("adminLoggedIn") === "true") {
        showAdminContent();
        showTab("tasks");
        loadTasks();
        loadUsers();
        loadStats();
        loadLogs();
      } else {
        document.getElementById("login-container").classList.remove("hidden");
      }
    }
    
    // Показать админ-контент
    function showAdminContent() {
      document.getElementById("login-container").classList.add("hidden");
      document.getElementById("admin-content").classList.remove("hidden");
    }
    
    // Переключение вкладок
    function showTab(tabName) {
      const tabs = document.querySelectorAll(".admin-tab-content");
      tabs.forEach(tab => tab.classList.add("hidden"));
      document.getElementById(tabName + "-tab").classList.remove("hidden");
      if (tabName === "stats") updateChart();
    }
    
    // Загрузка заданий из localStorage (ключ "tasks")
    function loadTasks() {
      const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const searchTerm = document.getElementById("task-search").value.toLowerCase();
      const filteredTasks = tasks.filter(task => task.text.toLowerCase().includes(searchTerm));
      const tasksList = document.getElementById("tasks-list");
      if (filteredTasks.length === 0) {
        tasksList.innerHTML = "<p>Нет заданий</p>";
        return;
      }
      tasksList.innerHTML = filteredTasks.map((task, index) => `
        <div class="card p-4 mb-2 bg-gray-800 rounded-lg">
          <p class="font-semibold">${task.text}</p>
          <p class="text-sm text-gray-400">Категория: ${task.category} | Статус: ${task.status}</p>
          <button onclick="viewTaskDetails(${index})" class="mt-2 px-2 py-1 bg-gray-500 rounded text-white">Подробнее</button>
          <div class="mt-2">
            <button onclick="adminEditTask(${index})" class="px-2 py-1 bg-blue-500 rounded text-white mr-2">Редактировать</button>
            <button onclick="adminDeleteTask(${index})" class="px-2 py-1 bg-red-500 rounded text-white">Удалить</button>
          </div>
        </div>
      `).join("");
    }
    
    // Функция просмотра деталей задания
    function viewTaskDetails(index) {
      const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const task = tasks[index];
      alert(`Детали задания:\n\nТекст: ${task.text}\nКатегория: ${task.category}\nСтатус: ${task.status}\nДополнительно: ${task.details || "Нет дополнительных данных"}`);
    }
    
    // Массовое удаление всех заданий
    function deleteAllTasks() {
      if (confirm("Удалить все задания?")) {
        localStorage.removeItem("tasks");
        addLog("Удалены все задания");
        loadTasks();
      }
    }
    
    // Загрузка пользователей из localStorage (ключ "users")
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const usersList = document.getElementById("users-list");
      if (users.length === 0) {
        usersList.innerHTML = "<p>Нет пользователей</p>";
        return;
      }
      usersList.innerHTML = users.map(user => `
        <div class="card p-4 mb-2 bg-gray-800 rounded-lg flex justify-between items-center">
          <div>
            <p class="font-semibold">${user.name || "Без имени"}</p>
            <p class="text-sm text-gray-400">Email: ${user.email || "Нет email"}</p>
            <p class="text-sm text-gray-400">Статус: ${user.banned ? "Забанен" : "Активен"}</p>
            <p class="text-sm text-gray-400">Премиум: ${user.premium ? "Да" : "Нет"}</p>
          </div>
          <div class="flex flex-col space-y-2">
            <button onclick="toggleBan('${user.id}')" class="px-2 py-1 bg-red-500 rounded text-white">
              ${user.banned ? "Разбанить" : "Забанить"}
            </button>
            <button onclick="togglePremium('${user.id}')" class="px-2 py-1 bg-green-500 rounded text-white">
              ${user.premium ? "Снять подписку" : "Дарить подписку"}
            </button>
          </div>
        </div>
      `).join("");
    }
    
    // Массовое разблокирование всех пользователей
    function unbanAllUsers() {
      let users = JSON.parse(localStorage.getItem("users") || "[]");
      users.forEach(user => user.banned = false);
      localStorage.setItem("users", JSON.stringify(users));
      addLog("Разбанены все пользователи");
      loadUsers();
    }
    
    // Загрузка статистики
    function loadStats() {
      const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const statsSummary = document.getElementById("stats-summary");
      const totalTasks = tasks.length;
      const totalUsers = users.length;
      const bannedUsers = users.filter(u => u.banned).length;
      statsSummary.innerHTML = `
        <p>Всего заданий: ${totalTasks}</p>
        <p>Всего пользователей: ${totalUsers}</p>
        <p>Забанено пользователей: ${bannedUsers}</p>
      `;
    }
    
    // Обновление графика статистики с помощью Chart.js
    let statsChart;
    function updateChart() {
      const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const categoryCounts = {};
      tasks.forEach(task => {
        categoryCounts[task.category] = (categoryCounts[task.category] || 0) + 1;
      });
      const labels = Object.keys(categoryCounts);
      const data = Object.values(categoryCounts);
      
      const ctx = document.getElementById('stats-chart').getContext('2d');
      if (statsChart) { statsChart.destroy(); }
      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Количество заданий по категориям',
            data: data,
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    
    // Загрузка журнала действий
    function loadLogs() {
      const logs = JSON.parse(localStorage.getItem("adminLogs") || "[]");
      const logsList = document.getElementById("logs-list");
      if (logs.length === 0) {
        logsList.innerHTML = "<p>Журнал пуст</p>";
        return;
      }
      logsList.innerHTML = logs.map(log => `<p>${log}</p>`).join("");
    }
    
    // Добавление записи в журнал действий
    function addLog(message) {
      const logs = JSON.parse(localStorage.getItem("adminLogs") || "[]");
      const timestamp = new Date().toLocaleString();
      logs.push(`[${timestamp}] ${message}`);
      localStorage.setItem("adminLogs", JSON.stringify(logs));
      loadLogs();
    }
    
    // Очистка журнала действий
    function clearLogs() {
      if (confirm("Очистить журнал действий?")) {
        localStorage.removeItem("adminLogs");
        loadLogs();
      }
    }
    
    // Функция отправки уведомления (рассылка)
    function sendBroadcast() {
      const message = document.getElementById("broadcast-message").value;
      if (!message) {
        alert("Введите сообщение для рассылки");
        return;
      }
      addLog(`Отправлено уведомление: ${message}`);
      alert("Уведомление отправлено");
      document.getElementById("broadcast-message").value = "";
    }
    
    // Админ-функции для редактирования и удаления заданий
    function adminEditTask(index) {
      const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const newText = prompt("Введите новый текст задания:", tasks[index].text);
      if (newText) {
        tasks[index].text = newText;
        localStorage.setItem("tasks", JSON.stringify(tasks));
        addLog(`Задание отредактировано: ${newText}`);
        loadTasks();
        showNotification("Задание обновлено");
      }
    }
    
    function adminDeleteTask(index) {
      if (confirm("Удалить задание?")) {
        const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
        const deletedTask = tasks[index].text;
        tasks.splice(index, 1);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        addLog(`Задание удалено: ${deletedTask}`);
        loadTasks();
        showNotification("Задание удалено");
      }
    }
    
    // Админ-функции для пользователей
    function toggleBan(userId) {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const user = users.find(u => u.id === userId);
      if (user) {
        user.banned = !user.banned;
        localStorage.setItem("users", JSON.stringify(users));
        addLog(`Пользователь ${user.name} ${user.banned ? "забанен" : "разбанен"}`);
        loadUsers();
        showNotification(`Пользователь ${user.name} ${user.banned ? "забанен" : "разбанен"}`);
      }
    }
    
    function togglePremium(userId) {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const user = users.find(u => u.id === userId);
      if (user) {
        user.premium = !user.premium;
        localStorage.setItem("users", JSON.stringify(users));
        addLog(`Подписка для ${user.name} ${user.premium ? "активирована" : "отключена"}`);
        loadUsers();
        showNotification(`Подписка для ${user.name} ${user.premium ? "активирована" : "отключена"}`);
      }
    }
    
    function showNotification(message) {
      const notif = document.createElement("div");
      notif.className = "fixed top-4 left-1/2 transform -translate-x-1/2 bg-teal-500 text-white p-3 rounded-lg shadow-lg";
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }
    
    // Инициализация админ-панели при загрузке страницы
    window.addEventListener("load", () => {
      checkAdminLogin();
    });
  </script>
</body>
</html>
